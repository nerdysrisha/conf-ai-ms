<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Documents - RAG Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        .upload-area.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        .file-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        .progress-container {
            margin-top: 15px;
            display: none;
        }
        .file-list {
            margin-top: 20px;
        }
        .file-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: white;
        }
        .supported-formats {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-robot"></i> RAG Assistant</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-comments"></i> Chat</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-upload"></i> Upload de Documents</h5>
                    </div>
                    <div class="card-body">
                        <div class="supported-formats">
                            <h6><i class="fas fa-info-circle"></i> Extraction Avancée</h6>
                            <p class="mb-1"><strong>Formats supportés:</strong> PDF (.pdf), Word (.docx), Texte (.txt), JSON (.json)</p>
                            <p class="mb-1"><strong>Taille max:</strong> 10 MB par fichier</p>
                            <div id="extractionCapabilities" class="mt-2">
                                <small class="text-muted">Chargement des capacités d'extraction...</small>
                            </div>
                        </div>

                        <div id="uploadArea" class="upload-area" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>Glissez vos fichiers ici ou cliquez pour sélectionner</h5>
                            <p class="text-muted">Les fichiers seront automatiquement chiffrés et indexés</p>
                            <input type="file" id="fileInput" style="display: none;" multiple 
                                   accept=".pdf,.docx,.txt,.json" onchange="handleFiles(this.files)">
                        </div>

                        <div id="progressContainer" class="progress-container">
                            <div class="progress">
                                <div id="progressBar" class="progress-bar" role="progressbar" 
                                     style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div id="progressText" class="text-center mt-2"></div>
                        </div>

                        <div id="uploadResults" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-files"></i> Documents existants</h6>
                    </div>
                    <div class="card-body">
                        <div id="filesList">
                            <p class="text-muted">Chargement...</p>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-shield-alt"></i> Sécurité</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <small>
                                <i class="fas fa-lock"></i> <strong>Chiffrement automatique</strong><br>
                                Tous vos fichiers sont chiffrés avec des clés RSA stockées dans Azure Key Vault
                                avant d'être sauvegardés dans Azure Storage.<br><br>
                                <i class="fas fa-brain"></i> <strong>Extraction intelligente</strong><br>
                                <span id="extractionMethod">Azure Document Intelligence utilisé pour une extraction avancée</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const uploadArea = document.getElementById('uploadArea');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        // Configuration de timeout par défaut (sera mise à jour depuis l'API)
        let uploadTimeoutMs = 120000; // 2 minutes par défaut
        
        // Récupérer la configuration de timeout depuis l'API
        async function loadUploadConfig() {
            try {
                const response = await fetch('/api/config/upload-timeout');
                if (response.ok) {
                    const config = await response.json();
                    uploadTimeoutMs = config.upload_timeout_ms;
                    console.log(`Configuration timeout chargée: ${uploadTimeoutMs/1000}s`);
                }
            } catch (error) {
                console.warn('Impossible de charger la configuration timeout, utilisation valeur par défaut');
            }
        }
        
        // Charger la configuration au démarrage
        loadUploadConfig();

        // Gestion du drag & drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        async function handleFiles(files) {
            if (files.length === 0) return;

            progressContainer.style.display = 'block';
            document.getElementById('uploadResults').innerHTML = '';

            const results = [];
            const totalFiles = files.length;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const progress = ((i) / totalFiles) * 100;
                
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                progressText.textContent = `Upload ${i + 1}/${totalFiles}: ${file.name}`;

                try {
                    const result = await uploadFile(file);
                    results.push({ file: file.name, success: true, result });
                } catch (error) {
                    let errorMessage = error.message;
                    if (error.name === 'AbortError') {
                        errorMessage = `Timeout: L'upload a pris trop de temps (plus de ${uploadTimeoutMs/1000} secondes)`;
                    }
                    results.push({ file: file.name, success: false, error: errorMessage });
                }
            }

            // Finaliser la progress bar
            progressBar.style.width = '100%';
            progressBar.setAttribute('aria-valuenow', 100);
            progressText.textContent = 'Upload terminé!';

            // Afficher les résultats
            displayResults(results);

            // Recharger la liste des fichiers
            loadFilesList();

            // Cacher la progress bar après un délai
            setTimeout(() => {
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
            }, 2000);
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            // Créer un AbortController pour gérer le timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), uploadTimeoutMs);

            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            });

            // Annuler le timeout si la requête réussit
            clearTimeout(timeoutId);

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Erreur lors de l\'upload');
            }

            return data;
        }

        function displayResults(results) {
            const resultsContainer = document.getElementById('uploadResults');
            let html = '<h6>Résultats de l\'upload:</h6>';

            results.forEach(result => {
                const alertClass = result.success ? 'alert-success' : 'alert-danger';
                const icon = result.success ? 'fa-check-circle' : 'fa-times-circle';
                
                html += `
                    <div class="alert ${alertClass} alert-dismissible fade show">
                        <i class="fas ${icon}"></i> 
                        <strong>${result.file}:</strong> 
                        ${result.success ? 'Uploadé et indexé avec succès' : result.error}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            });

            resultsContainer.innerHTML = html;
        }

        async function loadFilesList() {
            try {
                const response = await fetch('/api/files');
                const data = await response.json();

                const filesList = document.getElementById('filesList');

                if (data.success && data.files.length > 0) {
                    let html = '';
                    data.files.forEach(file => {
                        const uploadDate = new Date(file.last_modified).toLocaleDateString('fr-FR');
                        const sizeKB = Math.round(file.size / 1024);
                        
                        html += `
                            <div class="file-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>${file.metadata.original_filename || 'Fichier inconnu'}</strong><br>
                                        <small class="text-muted">
                                            ${uploadDate} • ${sizeKB} KB
                                        </small>
                                    </div>
                                    <div class="btn-group-vertical btn-group-sm">
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="downloadFile('${file.file_id}', '${file.metadata.original_filename}')">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="deleteFile('${file.file_id}', '${file.metadata.original_filename}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    filesList.innerHTML = html;
                } else {
                    filesList.innerHTML = '<p class="text-muted">Aucun document uploadé</p>';
                }
            } catch (error) {
                document.getElementById('filesList').innerHTML = 
                    '<p class="text-danger">Erreur lors du chargement des fichiers</p>';
            }
        }

        function downloadFile(fileId, filename) {
            window.open(`/api/files/${fileId}/decrypt`, '_blank');
        }

        async function deleteFile(fileId, filename) {
            if (!confirm(`Êtes-vous sûr de vouloir supprimer "${filename}" ?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/files/${fileId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Fichier supprimé avec succès');
                    loadFilesList();
                } else {
                    alert('Erreur lors de la suppression: ' + data.error);
                }
            } catch (error) {
                alert('Erreur lors de la suppression: ' + error.message);
            }
        }

        // Charger la liste des fichiers au démarrage
        loadFilesList();
        
        // Charger les informations sur les capacités d'extraction
        loadExtractionCapabilities();
        
        async function loadExtractionCapabilities() {
            try {
                const response = await fetch('/api/extraction-info');
                const data = await response.json();
                
                const capabilitiesDiv = document.getElementById('extractionCapabilities');
                const extractionMethodSpan = document.getElementById('extractionMethod');
                
                if (data.azure_doc_intelligence_available) {
                    capabilitiesDiv.innerHTML = `
                        <div class="badge bg-success me-2">Azure Document Intelligence</div>
                        <small class="text-success">✓ Extraction avancée activée</small>
                    `;
                    extractionMethodSpan.textContent = 'Azure Document Intelligence pour extraction avancée (texte, tableaux, structures)';
                } else {
                    capabilitiesDiv.innerHTML = `
                        <div class="badge bg-warning me-2">Méthodes de fallback</div>
                        <small class="text-warning">⚠ Extraction basique uniquement</small>
                    `;
                    extractionMethodSpan.textContent = 'Méthodes d\'extraction basiques (configuration Document Intelligence recommandée)';
                }
            } catch (error) {
                console.error('Erreur lors du chargement des capacités:', error);
            }
        }
    </script>
</body>
</html>
